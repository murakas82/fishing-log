<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add a fishing spot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
</head>
<body>
  <div class="app fade-in">
    <header class="card">
      <div class="card-header">
        <div>
          <h1>Add a fishing spot</h1>
          <p class="muted-text">
            Save a named spot with GPS coordinates.
          </p>
        </div>
        <button class="secondary-btn btn-back-main" id="backBtn">
          ← Back to main
        </button>
      </div>
    </header>

    <div class="card">
      <form id="spotForm">
        <label for="spotName">Spot name</label>
        <input id="spotName" type="text" placeholder="Paunküla" required />

        <label for="lat">Latitude</label>
        <input id="lat" type="number" step="0.000001" required />

        <label for="lng">Longitude</label>
        <input id="lng" type="number" step="0.000001" required />

        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
          <button type="button" class="secondary-btn" id="useLocationBtn">
            Use my location
          </button>
          <button type="submit" class="primary-btn">
            Save fishing spot
          </button>
        </div>
        <p id="formMessage" class="muted-text" style="margin-top:8px;"></p>
      </form>
    </div>

    <div class="card" style="position:relative;">
      <h2>Pick location on map</h2>
      <p class="muted-text">
        You can search or drag the marker. Latitude/Longitude fields update automatically.
      </p>
      <div class="map-search-container">
        <input id="mapSearchInput" type="text" placeholder="Search location…" />
      </div>
      <div id="map"></div>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const backBtn       = document.getElementById("backBtn");
    const spotForm      = document.getElementById("spotForm");
    const spotNameInput = document.getElementById("spotName");
    const latInput      = document.getElementById("lat");
    const lngInput      = document.getElementById("lng");
    const useLocationBtn = document.getElementById("useLocationBtn");
    const formMessage   = document.getElementById("formMessage");
    const mapSearchInput = document.getElementById("mapSearchInput");

    let currentUser = null;
    let map, marker;

    backBtn.onclick = () => {
      window.location.href = "index.html";
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      initMap();
    });

    function initMap() {
      map = L.map("map").setView([59.437, 24.7536], 8);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      marker = L.marker([59.437, 24.7536], { draggable: true }).addTo(map);

      marker.on("moveend", (e) => {
        const { lat, lng } = e.target.getLatLng();
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
      });

      map.on("click", (e) => {
        marker.setLatLng(e.latlng);
        latInput.value = e.latlng.lat.toFixed(6);
        lngInput.value = e.latlng.lng.toFixed(6);
      });

      // Simple search using Nominatim
      mapSearchInput.addEventListener("keydown", async (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        const queryText = mapSearchInput.value.trim();
        if (!queryText) return;
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              queryText
            )}`
          );
          const data = await res.json();
          if (!data.length) {
            formMessage.textContent = "Location not found.";
            return;
          }
          const place = data[0];
          const lat = parseFloat(place.lat);
          const lon = parseFloat(place.lon);
          map.setView([lat, lon], 12);
          marker.setLatLng([lat, lon]);
          latInput.value = lat.toFixed(6);
          lngInput.value = lon.toFixed(6);
        } catch (err) {
          formMessage.textContent = "Search error.";
        }
      });
    }

    useLocationBtn.onclick = () => {
      if (!navigator.geolocation) {
        formMessage.textContent = "Geolocation not available in this browser.";
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          latInput.value = lat.toFixed(6);
          lngInput.value = lng.toFixed(6);
          if (map && marker) {
            map.setView([lat, lng], 13);
            marker.setLatLng([lat, lng]);
          }
        },
        () => {
          formMessage.textContent = "Unable to get your location.";
        }
      );
    };

    function normalizeSpotName(name) {
      name = name.trim();
      if (!name) return "";
      return name.charAt(0).toUpperCase() + name.slice(1);
    }

    async function spotNameExistsForUser(userId, name) {
      const q = query(
        collection(db, "spots"),
        where("userId", "==", userId),
        where("name", "==", name)
      );
      const snap = await getDocs(q);
      return !snap.empty;
    }

    spotForm.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      formMessage.textContent = "";

      const rawName = spotNameInput.value;
      const name = normalizeSpotName(rawName);
      const lat  = parseFloat(latInput.value);
      const lng  = parseFloat(lngInput.value);

      if (!name || isNaN(lat) || isNaN(lng)) {
        formMessage.textContent = "Please fill all fields.";
        return;
      }

      if (await spotNameExistsForUser(currentUser.uid, name)) {
        formMessage.textContent = "You already have a spot with this name.";
        return;
      }

      try {
        await addDoc(collection(db, "spots"), {
          userId: currentUser.uid,
          name,
          latitude: lat,
          longitude: lng,
          createdAt: Date.now()
        });
        formMessage.textContent = "Spot saved.";
        spotForm.reset();
      } catch (err) {
        formMessage.textContent = "Error saving spot.";
      }
    };
  </script>
</body>
</html>
