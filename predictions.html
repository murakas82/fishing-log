
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Predictions • Fishing Log</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1,h2,h3 { margin: 0.2rem 0 0.6rem; }
    .muted { color: #6b7280; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    @media (prefers-color-scheme: dark) {
      .card { border-color: #374151; }
    }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid #9ca3af; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>Predictions</h1>
  <p class="muted">Forecast match vs your past catches at this spot.</p>
  <p>../index.html← Back to main</a></p>

  <h2>Loading spot…</h2>
  <div class="card">
    <label>Species for prediction</label>
    <select id="species">
      <option value="all">All species</option>
      <!-- TODO: populate from your catch history -->
    </select>
  </div>

  <h3>Next 3 days</h3>
  <div id="forecast" class="grid">
    <div class="card"><span class="spinner"></span> Loading forecast…</div>
  </div>

  <h3>Hot times tomorrow</h3>
  <div id="hot-times" class="card">
    <span class="spinner"></span> Loading hot times…
    <p class="muted">Times are between <strong>1 hour before sunrise</strong> and <strong>1 hour after sunset</strong>, based on your catches with weather data.</p>
  </div>

  <h3>Debug view (why these scores?)</h3>
  <div id="debug" class="card mono">
    <span class="spinner"></span> Loading debug information…
  </div>

  <script>
    // --- Configuration ---
    const coords = { latitude: 59.1177, longitude: 25.372767 }; // Keila area
    const DAYS_TO_SHOW = 3;

    // --- Build the corrected Open-Meteo URL ---
    // Notes:
    // - hourly: wind_speed_10m, weather_code (correct names)
    // - daily: valid variables (moon_phase is not supported in forecast API)
    // - timezone=auto uses local time based on coordinates
    const baseUrl = "https://api.open-meteo.com/v1/forecast";
    const params = new URLSearchParams({
      latitude: coords.latitude,
      longitude: coords.longitude,
      hourly: [
        "temperature_2m",
        "wind_speed_10m",
        "pressure_msl",
        "weather_code",
        "apparent_temperature"
      ].join(","),
      daily: [
        "temperature_2m_max",
        "temperature_2m_min",
        "weather_code",
        "sunrise",
        "sunset"
      ].join(","),
      timezone: "auto",
      forecast_days: "4"
    });
    const url = `${baseUrl}?${params.toString()}`;

    // --- Helpers ---
    const WMO_CODES = {
      // minimal mapping for demo; expand as you like
      0: "Clear",
      1: "Mainly clear",
      2: "Partly cloudy",
      3: "Overcast",
      45: "Fog",
      48: "Depositing rime fog",
      51: "Drizzle: light",
      53: "Drizzle: moderate",
      55: "Drizzle: dense",
      61: "Rain: slight",
      63: "Rain: moderate",
      65: "Rain: heavy",
      71: "Snow fall: slight",
      73: "Snow fall: moderate",
      75: "Snow fall: heavy",
      80: "Rain showers: slight",
      81: "Rain showers: moderate",
      82: "Rain showers: violent",
      95: "Thunderstorm",
      96: "Thunderstorm with hail",
      99: "Thunderstorm with heavy hail"
    };

    function fmtTimeLocal(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }
    function fmtDateLocal(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString([], { weekday: "short", month: "short", day: "numeric" });
    }

    // --- Renderers ---
    function renderForecast(daily) {
      const holder = document.getElementById("forecast");
      holder.innerHTML = "";

      const count = Math.min(DAYS_TO_SHOW, daily.time.length);
      for (let i = 0; i < count; i++) {
        const date = daily.time[i];
        const tMax = daily.temperature_2m_max[i];
        const tMin = daily.temperature_2m_min[i];
        const wmo = daily.weather_code[i];
        const sunrise = daily.sunrise[i];
        const sunset = daily.sunset[i];

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h4>${fmtDateLocal(date)}</h4>
          <p><strong>${tMax}° / ${tMin}°</strong></p>
          <p>${WMO_CODES[wmo] ?? "Weather code " + wmo}</p>
          <p>Sunrise: ${fmtTimeLocal(sunrise)} • Sunset: ${fmtTimeLocal(sunset)}</p>
        `;
        holder.appendChild(card);
      }
    }

    function renderHotTimesTomorrow(daily) {
      const el = document.getElementById("hot-times");
      const tomorrowIndex = 1; // index 0 = today, 1 = tomorrow
      if (daily.sunrise?.[tomorrowIndex] && daily.sunset?.[tomorrowIndex]) {
        const sunriseIso = daily.sunrise[tomorrowIndex];
        const sunsetIso = daily.sunset[tomorrowIndex];
        const beforeSunrise = new Date(new Date(sunriseIso).getTime() - 60 * 60 * 1000);
        const afterSunset = new Date(new Date(sunsetIso).getTime() + 60 * 60 * 1000);

        el.innerHTML = `
          <p><strong>${fmtDateLocal(daily.time[tomorrowIndex])}</strong></p>
          <p>Start: ${beforeSunrise.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</p>
          <p>End: ${afterSunset.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</p>
        `;
      } else {
        el.textContent = "No sunrise/sunset data available.";
      }
    }

    function renderDebug(json) {
      const el = document.getElementById("debug");
      el.textContent = JSON.stringify({
        url,
        latitude: json.latitude,
        longitude: json.longitude,
        timezone: json.timezone,
        daily_units: json.daily_units,
        sample_daily: json.daily?.time?.slice(0, 3)
      }, null, 2);
    }

    // --- Fetch & render ---
    (async function load() {
      try {
        const res = await fetch(url, { mode: "cors" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        renderForecast(data.daily);
        renderHotTimesTomorrow(data.daily);
        renderDebug(data);
      } catch (err) {
        document.getElementById("forecast").innerHTML =
          `<div class="card">API error: ${String(err)}</div>`;
        document.getElementById("hot-times").innerHTML =
          `Failed to load: ${String(err)}`;
        document.getElementById("debug").textContent = String(err);
      }
    })();
  </script>
</body>
</html>
