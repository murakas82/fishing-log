<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add a catch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app fade-in">
    <header class="card">
      <div class="card-header">
        <div>
          <h1>Add a catch</h1>
          <p class="muted-text">
            Log a catch with weight, spot, weather and notes.
          </p>
        </div>
        <button class="secondary-btn btn-back-main" id="backBtn">
          ← Back to main
        </button>
      </div>
    </header>

    <div class="card">
      <form id="catchForm">
        <label for="species">Species</label>
        <input id="species" type="text" placeholder="Pike, perch…" />

        <label for="weight">Weight (kg)</label>
        <input id="weight" type="number" step="0.01" min="0" />

        <label for="spotSelect">Fishing spot (required)</label>
        <select id="spotSelect" required>
          <option value="">Select spot…</option>
        </select>

        <label for="lure">Lure</label>
        <input id="lure" type="text" placeholder="Spinner, jig, worm…" />

        <label for="depth">Water depth (m)</label>
        <input id="depth" type="number" step="0.1" min="0" />

        <label for="waterTemp">Water temperature (°C)</label>
        <input id="waterTemp" type="number" step="0.1" />

        <label for="lat">Latitude (auto from spot or GPS)</label>
        <input id="lat" type="number" step="0.000001" />

        <label for="lng">Longitude (auto from spot or GPS)</label>
        <input id="lng" type="number" step="0.000001" />

        <button type="button" class="secondary-btn" id="useLocationBtn">
          Use my location
        </button>

        <p id="weatherNowText" class="muted-text" style="margin-top:8px;">
          Weather now: (loading when lat/lng known)
        </p>

        <label for="notes">Notes</label>
        <textarea
          id="notes"
          placeholder="Weather, behaviour, etc."
        ></textarea>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
          <button type="submit" class="primary-btn">Save catch</button>
          <button type="button" class="secondary-btn btn-back-main" id="backBtn2">
            ← Back to main
          </button>
        </div>

        <p id="formMessage" class="muted-text" style="margin-top:8px;"></p>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const backBtn   = document.getElementById("backBtn");
    const backBtn2  = document.getElementById("backBtn2");
    const form      = document.getElementById("catchForm");
    const speciesEl = document.getElementById("species");
    const weightEl  = document.getElementById("weight");
    const spotSelect = document.getElementById("spotSelect");
    const lureEl    = document.getElementById("lure");
    const depthEl   = document.getElementById("depth");
    const waterTempEl = document.getElementById("waterTemp");
    const latEl     = document.getElementById("lat");
    const lngEl     = document.getElementById("lng");
    const useLocationBtn = document.getElementById("useLocationBtn");
    const notesEl   = document.getElementById("notes");
    const weatherNowText = document.getElementById("weatherNowText");
    const formMessage = document.getElementById("formMessage");

    let currentUser = null;
    let spots = [];

    backBtn.onclick = backToMain;
    backBtn2.onclick = backToMain;

    function backToMain() {
      window.location.href = "index.html";
    }

    function getSpotIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("spotId");
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      await loadSpots();

      const spotIdFromUrl = getSpotIdFromUrl();
      if (spotIdFromUrl) {
        spotSelect.value = spotIdFromUrl;
        const spot = spots.find(s => s.id === spotIdFromUrl);
        if (spot) {
          latEl.value = spot.latitude?.toFixed(6) || "";
          lngEl.value = spot.longitude?.toFixed(6) || "";
          await fetchWeatherNow();
        }
      }
    });

    async function loadSpots() {
      const q = query(
        collection(db, "spots"),
        where("userId", "==", currentUser.uid)
      );
      const snap = await getDocs(q);
      spots = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      spotSelect.innerHTML = `<option value="">Select spot…</option>`;
      spots.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name || "Unnamed spot";
        spotSelect.appendChild(opt);
      });
    }

    spotSelect.onchange = async () => {
      const spotId = spotSelect.value;
      const spot = spots.find(s => s.id === spotId);
      if (!spot) return;
      if (typeof spot.latitude === "number") {
        latEl.value = spot.latitude.toFixed(6);
      }
      if (typeof spot.longitude === "number") {
        lngEl.value = spot.longitude.toFixed(6);
      }
      await fetchWeatherNow();
    };

    useLocationBtn.onclick = () => {
      if (!navigator.geolocation) {
        formMessage.textContent = "Geolocation not available.";
        return;
      }
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          latEl.value = lat.toFixed(6);
          lngEl.value = lng.toFixed(6);
          await fetchWeatherNow();
        },
        () => {
          formMessage.textContent = "Unable to get your location.";
        }
      );
    };

    async function fetchWeatherNow() {
      const lat = parseFloat(latEl.value);
      const lng = parseFloat(lngEl.value);
      if (isNaN(lat) || isNaN(lng)) {
        weatherNowText.textContent = "Weather now: need valid latitude & longitude.";
        return;
      }

      try {
        weatherNowText.textContent = "Weather now: loading…";

        const url =
          `https://api.open-meteo.com/v1/forecast` +
          `?latitude=${lat}&longitude=${lng}` +
          `&current=temperature_2m,wind_speed_10m,weather_code,pressure_msl` +
          `&wind_speed_unit=ms&timezone=auto`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const cur = data.current || {};
        const temp = cur.temperature_2m;
        const wind = cur.wind_speed_10m;
        const press = cur.pressure_msl;
        const code = cur.weather_code;

        const label = codeDescription(code);
        weatherNowText.textContent =
          `Weather now: ${label}, ${temp?.toFixed?.(1) ?? "?"} °C, wind ${wind?.toFixed?.(1) ?? "?"} m/s`;
        return { temp, wind, press, label };
      } catch {
        weatherNowText.textContent = "Weather now: failed to load.";
        return null;
      }
    }

    function codeDescription(code) {
      if (code === 0) return "Clear";
      if (code === 1) return "Mainly clear";
      if (code === 2) return "Partly cloudy";
      if (code === 3) return "Overcast";
      if (code >= 51 && code <= 57) return "Drizzle";
      if (code >= 61 && code <= 67) return "Rain";
      if (code >= 71 && code <= 77) return "Snow";
      if (code >= 80 && code <= 82) return "Rain showers";
      if (code >= 85 && code <= 86) return "Snow showers";
      if (code === 95) return "Thunderstorm";
      if (code === 96 || code === 99) return "Thunderstorm with hail";
      return "Unknown";
    }

    function getApproxMoonPhase(date) {
      const lp = 2551443;
      const knownNewMoon = Date.UTC(2000, 0, 6, 18, 14);
      const diff = date.getTime() - knownNewMoon;
      const phase = (diff / 1000) % lp;
      let frac = phase / lp;
      if (frac < 0) frac += 1;
      return frac;
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      formMessage.textContent = "";

      const species = speciesEl.value.trim() || "unknown";
      const weight = parseFloat(weightEl.value) || 0;
      const spotId = spotSelect.value;
      if (!spotId) {
        formMessage.textContent = "Select a fishing spot.";
        return;
      }
      const spot = spots.find(s => s.id === spotId);
      const spotName = spot?.name || "Unknown";

      const lure = lureEl.value.trim();
      const depth = parseFloat(depthEl.value);
      const waterTemp = parseFloat(waterTempEl.value);

      const lat = parseFloat(latEl.value);
      const lng = parseFloat(lngEl.value);

      const now = new Date();
      const moonPhase = getApproxMoonPhase(now);

      let weatherTemp = null;
      let weatherWindMs = null;
      let weatherPressure = null;
      let weatherCondition = null;
      let weatherDescription = null;

      if (!isNaN(lat) && !isNaN(lng)) {
        const w = await fetchWeatherNow();
        if (w) {
          weatherTemp = w.temp;
          weatherWindMs = w.wind;
          weatherPressure = w.press;
          weatherCondition = w.label;
          if (typeof w.temp === "number" && typeof w.wind === "number") {
            weatherDescription = `${w.label}, ${w.temp.toFixed(
              1
            )} °C, wind ${w.wind.toFixed(1)} m/s`;
          } else {
            weatherDescription = w.label;
          }
        }
      }

      try {
        await addDoc(collection(db, "catches"), {
          userId: currentUser.uid,
          timestamp: Date.now(),
          species,
          weightKg: weight,
          spotId,
          spotName,
          lure,
          depth: !isNaN(depth) ? depth : null,
          waterTemp: !isNaN(waterTemp) ? waterTemp : null,
          latitude: !isNaN(lat) ? lat : null,
          longitude: !isNaN(lng) ? lng : null,
          notes: notesEl.value.trim(),
          weatherTemp,
          weatherWindMs,
          weatherPressure,
          weatherCondition,
          weatherDescription,
          moonPhase
        });
        formMessage.textContent = "Catch saved.";
        form.reset();
      } catch (err) {
        formMessage.textContent = "Error saving catch.";
      }
    };
  </script>
</body>
</html>
