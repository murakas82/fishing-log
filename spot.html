<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fishing spot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app fade-in">
    <header class="card">
      <div class="card-header">
        <div>
          <h1>Fishing spot</h1>
          <p class="muted-text">See details and catches for this spot.</p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="secondary-btn btn-back-main" id="backToMainBtn">
            ← Back to main
          </button>
        </div>
      </div>
    </header>

    <div class="card" id="spotHeaderCard">
      <div class="card-header">
        <div>
          <h2 id="spotNameHeading" style="margin:0 0 4px;">Loading spot…</h2>
          <p id="spotInfo" class="muted-text" style="margin:0;">
            Loading data…
          </p>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="secondary-btn" id="addCatchBtn">Add catch</button>
          <button class="secondary-btn" id="predictionsBtn">Predictions</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Catches at this spot</h2>
      <div id="catchesContainer">
        <p class="muted-text">Loading catches…</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      where,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const spotNameHeading   = document.getElementById("spotNameHeading");
    const spotInfoEl        = document.getElementById("spotInfo");
    const catchesContainer  = document.getElementById("catchesContainer");
    const backToMainBtn     = document.getElementById("backToMainBtn");
    const addCatchBtn       = document.getElementById("addCatchBtn");
    const predictionsBtn    = document.getElementById("predictionsBtn");

    let currentUser = null;
    let currentSpot = null;

    function getSpotIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function formatDate(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    backToMainBtn.onclick = () => {
      window.location.href = "index.html";
    };

    addCatchBtn.onclick = () => {
      if (!currentSpot) return;
      window.location.href =
        `add-catch.html?spotId=${encodeURIComponent(currentSpot.id)}`;
    };

    predictionsBtn.onclick = () => {
      if (!currentSpot) return;
      window.location.href =
        `predictions.html?spotId=${encodeURIComponent(currentSpot.id)}`;
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      const spotId = getSpotIdFromUrl();
      if (!spotId) {
        spotNameHeading.textContent = "No spot selected";
        spotInfoEl.textContent = "Missing id in URL.";
        catchesContainer.innerHTML = "";
        return;
      }

      await loadSpot(spotId);
      await loadCatches(spotId);
    });

    async function loadSpot(spotId) {
      try {
        const snap = await getDoc(doc(db, "spots", spotId));
        if (!snap.exists()) {
          spotNameHeading.textContent = "Spot not found";
          spotInfoEl.textContent = "This spot does not exist.";
          return;
        }
        currentSpot = { id: snap.id, ...snap.data() };
        spotNameHeading.textContent = currentSpot.name || "Unnamed spot";

        const infoParts = [];
        if (typeof currentSpot.latitude === "number" &&
            typeof currentSpot.longitude === "number") {
          infoParts.push(
            `Location: ${currentSpot.latitude.toFixed(4)}, ${currentSpot.longitude.toFixed(4)}`
          );
        }
        spotInfoEl.textContent =
          infoParts.length ? infoParts.join(" • ") : "No additional info.";
      } catch {
        spotNameHeading.textContent = "Error loading spot";
        spotInfoEl.textContent = "Failed to load spot data.";
      }
    }

    async function loadCatches(spotId) {
      catchesContainer.innerHTML =
        `<p class="muted-text">Loading catches…</p>`;

      try {
        const q = query(
          collection(db, "catches"),
          where("userId", "==", currentUser.uid),
          where("spotId", "==", spotId)
        );
        const snap = await getDocs(q);
        const catches = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        if (!catches.length) {
          catchesContainer.innerHTML =
            `<p class="muted-text">No catches logged at this spot yet.</p>`;
          return;
        }

        catches.sort((a, b) => b.timestamp - a.timestamp);
        catchesContainer.innerHTML = "";

        for (const c of catches) {
          const div = document.createElement("div");
          div.style.marginBottom = "16px";

          const species = c.species || "Unknown species";
          const weight = typeof c.weightKg === "number" && !isNaN(c.weightKg)
            ? `${c.weightKg.toFixed(2)} kg`
            : "-";

          const dateStr = formatDate(c.timestamp);
          const lure = c.lure?.trim() || "-";
          const depthStr =
            typeof c.depth === "number" && !isNaN(c.depth)
              ? `${c.depth.toFixed(1)} m`
              : "-";
          const waterTempStr =
            typeof c.waterTemp === "number" && !isNaN(c.waterTemp)
              ? `${c.waterTemp.toFixed(1)} °C`
              : "-";

          let weatherText = "-";
          if (c.weatherDescription?.trim()) {
            weatherText = c.weatherDescription.trim();
          } else {
            const parts = [];
            if (typeof c.weatherTemp === "number" && !isNaN(c.weatherTemp)) {
              parts.push(`${c.weatherTemp.toFixed(1)} °C`);
            }
            if (c.weatherCondition?.trim()) {
              parts.push(c.weatherCondition.trim());
            }
            if (typeof c.weatherWindMs === "number" && !isNaN(c.weatherWindMs)) {
              parts.push(`wind ${c.weatherWindMs.toFixed(1)} m/s`);
            }
            if (parts.length) weatherText = parts.join(", ");
          }

          div.innerHTML = `
            <div>
              <strong>${species}</strong> • ${weight} ${dateStr}<br/>
              Lure: ${lure}<br/>
              Depth: ${depthStr}<br/>
              Water temp: ${waterTempStr}<br/>
              Weather at time of catch: ${weatherText}
            </div>
          `;

          const btn = document.createElement("button");
          btn.textContent = "Delete catch";
          btn.className = "danger-btn";
          btn.style.marginTop = "6px";
          btn.onclick = () => handleDeleteCatch(c.id);

          div.appendChild(document.createElement("br"));
          div.appendChild(btn);

          catchesContainer.appendChild(div);
        }
      } catch {
        catchesContainer.innerHTML =
          `<p class="muted-text">Failed to load catches.</p>`;
      }
    }

    async function handleDeleteCatch(catchId) {
      if (!confirm("Delete this catch? This cannot be undone.")) return;
      try {
        await deleteDoc(doc(db, "catches", catchId));
        await loadCatches(currentSpot.id);
      } catch {
        alert("Failed to delete catch.");
      }
    }
  </script>
</body>
</html>
