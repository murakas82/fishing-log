<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Fishing Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Load external CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <header>
      <h1>My Fishing Log</h1>
      <p>Track your catches anywhere – works on mobile too.</p>
    </header>

    <!-- Stats Card -->
    <div class="card">
      <h2 class="section-title">Stats</h2>
      <div id="stats" class="stats-container">
        <p class="empty-state">No stats yet – add your first catch!</p>
      </div>
    </div>

    <!-- Add Catch Form -->
    <div class="card">
      <h2 class="section-title">Add a catch</h2>

      <label for="species">Species</label>
      <input id="species" type="text" placeholder="Pike, Perch, Carp..." />

      <label for="weight">Weight (kg)</label>
      <input id="weight" type="number" step="0.01" placeholder="e.g. 2.4" />

      <label for="spot">Spot name</label>
      <input id="spot" type="text" placeholder="Lake X, River Y..." />

      <label for="notes">Notes (optional)</label>
      <textarea id="notes" placeholder="Weather, lure, depth, etc."></textarea>

      <label for="photo">Photo (optional)</label>
      <input id="photo" type="file" accept="image/*" />

      <button id="addCatchBtn">Save catch</button>
    </div>

    <!-- List of catches -->
    <div class="card">
      <h2 class="section-title">Your catches</h2>
      <div id="catchList" class="catch-list">
        <p class="empty-state">No catches yet. Add your first one!</p>
      </div>
    </div>
  </div>

  <script>
    // --- Data handling ---

    function loadCatches() {
      const json = localStorage.getItem("fishing_catches");
      if (!json) return [];
      try {
        return JSON.parse(json);
      } catch (e) {
        console.error("Error parsing stored catches", e);
        return [];
      }
    }

    function saveCatches(catches) {
      localStorage.setItem("fishing_catches", JSON.stringify(catches));
    }

    let catches = loadCatches();

    // --- Delete a catch ---

    function deleteCatch(id) {
      const confirmed = confirm("Delete this catch? This cannot be undone.");
      if (!confirmed) return;

      catches = catches.filter(c => c.id !== id);
      saveCatches(catches);
      renderCatches();
    }

    // --- Stats rendering ---

    function renderStats() {
      const statsEl = document.getElementById("stats");
      if (!statsEl) return;

      statsEl.innerHTML = "";

      if (catches.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-state";
        p.textContent = "No stats yet – add your first catch!";
        statsEl.appendChild(p);
        return;
      }

      const total = catches.length;
      let biggest = catches[0];
      let totalWeight = 0;
      const speciesCounts = {};

      catches.forEach(c => {
        const w = typeof c.weightKg === "number" ? c.weightKg : 0;
        totalWeight += w;
        if (w > (biggest.weightKg || 0)) {
          biggest = c;
        }
        if (c.species) {
          speciesCounts[c.species] = (speciesCounts[c.species] || 0) + 1;
        }
      });

      const avgWeight = totalWeight / total;
      let topSpecies = null;
      let topCount = 0;
      for (const [species, count] of Object.entries(speciesCounts)) {
        if (count > topCount) {
          topCount = count;
          topSpecies = species;
        }
      }

      const list = document.createElement("div");
      list.className = "stats";

      function addStat(label, value) {
        const item = document.createElement("div");
        item.className = "stat-pill";
        item.innerHTML = `
          <span class="stat-label">${label}</span>
          <span class="stat-value">${value}</span>
        `;
        list.appendChild(item);
      }

      addStat("Total", `${total} catch${total === 1 ? "" : "es"}`);
      addStat("Biggest", `${biggest.weightKg.toFixed(2)} kg ${biggest.species}`);
      addStat("Avg weight", `${avgWeight.toFixed(2)} kg`);
      if (topSpecies) {
        addStat("Most common", `${topSpecies} (${topCount})`);
      }

      statsEl.appendChild(list);
    }

    // --- Rendering catches ---

    function renderCatches() {
      const listEl = document.getElementById("catchList");
      listEl.innerHTML = "";

      if (catches.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-state";
        p.textContent = "No catches yet. Add your first one!";
        listEl.appendChild(p);
        // Also update stats
        renderStats();
        return;
      }

      catches
        .slice()
        .reverse() // newest first
        .forEach(c => {
          const wrapper = document.createElement("div");
          wrapper.className = "catch-item";

          const top = document.createElement("div");
          top.className = "catch-top";
          top.innerHTML = `
            <span>${c.species} • ${c.weightKg.toFixed(2)} kg</span>
            <span>${new Date(c.timestamp).toLocaleDateString()}</span>
          `;

          const meta = document.createElement("div");
          meta.className = "catch-meta";
          meta.textContent = c.spotName || "Unknown spot";

          const note = document.createElement("div");
          note.className = "catch-meta";
          note.textContent = c.notes || "";

          wrapper.appendChild(top);
          wrapper.appendChild(meta);
          if (c.notes) wrapper.appendChild(note);

          if (c.photoDataUrl) {
            const img = document.createElement("img");
            img.className = "catch-photo";
            img.src = c.photoDataUrl;
            img.alt = `${c.species} photo`;
            wrapper.appendChild(img);
          }

          const actions = document.createElement("div");
          actions.className = "catch-actions";

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "Delete";
          deleteBtn.addEventListener("click", () => deleteCatch(c.id));

          actions.appendChild(deleteBtn);
          wrapper.appendChild(actions);

          const separator = document.createElement("div");
          separator.style.height = "12px";

          listEl.appendChild(wrapper);
          listEl.appendChild(separator);
        });

      // Update stats whenever the catch list changes
      renderStats();
    }

    // --- Save Catch ---

    document.getElementById("addCatchBtn").addEventListener("click", () => {
      const speciesInput = document.getElementById("species");
      const weightInput = document.getElementById("weight");
      const spotInput = document.getElementById("spot");
      const notesInput = document.getElementById("notes");
      const photoInput = document.getElementById("photo");

      const species = speciesInput.value.trim();
      const weightValue = parseFloat(weightInput.value);
      const spotValue = spotInput.value.trim();
      const notesValue = notesInput.value.trim();
      const file = photoInput.files[0];

      if (!species || isNaN(weightValue)) {
        alert("Please enter at least species and weight.");
        return;
      }

      const createCatch = (photoDataUrl) => {
        const newCatch = {
          id: Date.now(),
          species,
          weightKg: weightValue,
          spotName: spotValue,
          notes: notesValue,
          timestamp: Date.now(),
          photoDataUrl
        };

        catches.push(newCatch);
        saveCatches(catches);
        renderCatches();

        // clear form
        speciesInput.value = "";
        weightInput.value = "";
        spotInput.value = "";
        notesInput.value = "";
        photoInput.value = "";
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => createCatch(event.target.result);
        reader.readAsDataURL(file);
      } else {
        createCatch(null);
      }
    });

    // Initial render
    renderCatches();
  </script>
</body>
</html>
