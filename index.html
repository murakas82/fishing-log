<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Fishing Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://www.googleapis.com">

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app fade-in">
    <header>
      <h1>My Fishing Log</h1>
      <p>Track your catches anywhere â€“ with login & cloud sync.</p>
    </header>

    <!-- GLOBAL LOADING -->
    <div id="loadingCard" class="loading-spinner-wrapper">
      <div class="loading-spinner"></div>
    </div>

    <!-- AUTH CARD (email/password only) -->
    <div class="card" id="authCard" style="display:none;">
      <h2>Log in or sign up</h2>

      <label for="authEmail">Email</label>
      <input id="authEmail" type="email" autocomplete="email" />

      <label for="authPassword">Password</label>
      <input id="authPassword" type="password" autocomplete="current-password" />

      <div class="auth-buttons">
        <button id="loginBtn">Log in</button>
        <button id="signupBtn" class="secondary-btn">Sign up</button>
      </div>

      <p id="authMessage" class="auth-message"></p>
    </div>

    <!-- USER CARD + SETTINGS BUTTON -->
    <div class="card" id="userCard" style="display:none;">
      <div class="user-row">
        <div>
          <div class="user-label">Logged in as</div>
          <div class="user-email" id="userDisplayName"></div>
        </div>
        <div class="user-actions">
          <button id="settingsBtn" class="secondary-btn">Settings</button>
          <button id="logoutBtn" class="secondary-btn">Log out</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS CARD -->
    <div class="card" id="settingsCard" style="display:none;">
      <h2>Settings</h2>

      <label for="displayNameInput">Display name</label>
      <input id="displayNameInput" type="text" placeholder="Your name" />

      <div class="auth-buttons">
        <button id="saveSettingsBtn">Save</button>
        <button id="cancelSettingsBtn" class="secondary-btn">Cancel</button>
      </div>

      <p id="settingsMessage" class="auth-message"></p>
    </div>

    <!-- MAIN CONTENT -->
    <div id="appContent" style="display:none;">

      <!-- GLOBAL STATS -->
      <div class="card">
        <h2>Stats</h2>
        <div id="stats" class="stats-container"></div>
      </div>

      <!-- FISHING SPOTS -->
      <div class="card">
        <div class="spots-header-row">
          <h2>My fishing spots</h2>
          <div class="spots-header-actions">
            <button id="goMapViewBtn" class="tiny-secondary-btn">Map view</button>
            <button id="goAddSpotBtn" class="tiny-secondary-btn">Add new spot</button>
          </div>
        </div>

        <div id="spotsContainer" class="spots-container"></div>
      </div>
    </div>
  </div>

  <!-- FIREBASE + APP LOGIC -->
  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    import {
      getFirestore,
      collection, getDocs,
      query, where,
      doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    /* FIREBASE CONFIG (your project) */
    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* DOM REFS */
    const loadingCard      = document.getElementById("loadingCard");
    const authCard         = document.getElementById("authCard");
    const userCard         = document.getElementById("userCard");
    const appContent       = document.getElementById("appContent");
    const displayNameEl    = document.getElementById("userDisplayName");

    const emailEl          = document.getElementById("authEmail");
    const passEl           = document.getElementById("authPassword");
    const authMsgEl        = document.getElementById("authMessage");

    const settingsCard     = document.getElementById("settingsCard");
    const settingsBtn      = document.getElementById("settingsBtn");
    const saveSettingsBtn  = document.getElementById("saveSettingsBtn");
    const cancelSettingsBtn= document.getElementById("cancelSettingsBtn");
    const displayNameInput = document.getElementById("displayNameInput");
    const settingsMessage  = document.getElementById("settingsMessage");

    const goAddSpotBtn     = document.getElementById("goAddSpotBtn");
    const goMapViewBtn     = document.getElementById("goMapViewBtn");

    let currentUser = null;
    let catches = [];
    let spots   = [];
    let currentUserEmail = "";

    /* ---------------- AUTH BUTTONS ---------------- */

    document.getElementById("loginBtn").onclick = async () => {
      authMsgEl.textContent = "";
      try {
        await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
      } catch (err) {
        authMsgEl.textContent = err.message;
      }
    };

    document.getElementById("signupBtn").onclick = async () => {
      authMsgEl.textContent = "";
      try {
        await createUserWithEmailAndPassword(auth, emailEl.value, passEl.value);
      } catch (err) {
        authMsgEl.textContent = err.message;
      }
    };

    document.getElementById("logoutBtn").onclick = () => signOut(auth);

    goAddSpotBtn.onclick = () => window.location.href = "add-spot.html";
    goMapViewBtn.onclick = () => window.location.href = "spots-map.html";

    /* ---------------- SETTINGS ---------------- */

    settingsBtn.onclick = () => {
      if (!currentUser) return;
      settingsMessage.textContent = "";
      settingsCard.style.display = "block";
      displayNameInput.value = displayNameEl.textContent || currentUserEmail || "";
    };

    cancelSettingsBtn.onclick = () => {
      settingsCard.style.display = "none";
      settingsMessage.textContent = "";
    };

    saveSettingsBtn.onclick = async () => {
      if (!currentUser) return;
      const name = displayNameInput.value.trim();
      if (!name) {
        settingsMessage.textContent = "Please enter a display name.";
        return;
      }

      try {
        const userDocRef = doc(db, "users", currentUser.uid);
        await setDoc(userDocRef, { displayName: name }, { merge: true });
        displayNameEl.textContent = name;
        settingsMessage.textContent = "Saved!";
        setTimeout(() => {
          settingsCard.style.display = "none";
          settingsMessage.textContent = "";
        }, 600);
      } catch (err) {
        console.error(err);
        settingsMessage.textContent = "Failed to save settings.";
      }
    };

    async function loadUserProfile(user) {
      currentUserEmail = user.email || "";
      let displayName = "";

      try {
        const userDocRef = doc(db, "users", user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          const data = snap.data();
          if (data.displayName) displayName = data.displayName;
        }
      } catch (err) {
        console.error("Error loading user profile:", err);
      }

      displayNameEl.textContent = displayName || currentUserEmail;
    }

    /* ---------------- AUTH STATE ---------------- */

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      loadingCard.style.display = "none";

      if (user) {
        authCard.style.display   = "none";
        userCard.style.display   = "block";
        appContent.style.display = "block";

        await loadUserProfile(user);

        showStatsLoading();
        await Promise.all([loadCatches(), loadSpots()]);
        renderStats();
        renderSpots();
      } else {
        authCard.style.display   = "block";
        userCard.style.display   = "none";
        appContent.style.display = "none";
        settingsCard.style.display = "none";
      }
    });

    /* ---------------- DATA LOAD ---------------- */

    async function loadCatches() {
      const q = query(collection(db, "catches"), where("userId", "==", currentUser.uid));
      const snap = await getDocs(q);
      catches = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function loadSpots() {
      const q = query(collection(db, "spots"), where("userId", "==", currentUser.uid));
      const snap = await getDocs(q);
      spots = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    /* ---------------- STATS ---------------- */

    function showStatsLoading() {
      const statsEl = document.getElementById("stats");
      if (!statsEl) return;
      statsEl.innerHTML = `
        <div class="loading-spinner-wrapper section-loading">
          <div class="loading-spinner"></div>
        </div>
      `;
    }

    function renderStats() {
      const statsEl = document.getElementById("stats");
      statsEl.innerHTML = "";

      if (!catches.length) {
        statsEl.innerHTML = `<p class="empty-state">No stats yet â€“ add your first catch!</p>`;
        return;
      }

      const total = catches.length;
      let biggest = catches[0];
      let sum = 0;

      catches.forEach(c => {
        const w = Number(c.weightKg) || 0;
        sum += w;
        if (w > Number(biggest.weightKg || 0)) biggest = c;
      });

      const avg = sum / total;

      const container = document.createElement("div");

      const pill = (label, value) => {
        const div = document.createElement("div");
        div.className = "stat-pill";
        div.innerHTML = `
          <span class="stat-label">${label}</span>
          <span class="stat-value">${value}</span>
        `;
        container.appendChild(div);
      };

      pill("Total catches", total);
      pill("Biggest fish", `${Number(biggest.weightKg).toFixed(2)} kg ${biggest.species}`);
      pill("Average weight", `${avg.toFixed(2)} kg`);

      statsEl.appendChild(container);
    }

    /* ---------------- WEATHER HELPER ---------------- */

    function getWeatherIconAndLabel(code) {
      if (code === 0) return { icon: "â˜€ï¸", label: "Clear sky" };
      if (code === 1) return { icon: "ðŸŒ¤ï¸", label: "Mainly clear" };
      if (code === 2) return { icon: "â›…", label: "Partly cloudy" };
      if (code === 3) return { icon: "â˜ï¸", label: "Overcast" };
      if (code === 45 || code === 48) return { icon: "ðŸŒ«ï¸", label: "Fog" };
      if (code >= 51 && code <= 57) return { icon: "ðŸŒ¦ï¸", label: "Drizzle" };
      if (code >= 61 && code <= 67) return { icon: "ðŸŒ§ï¸", label: "Rain" };
      if (code >= 71 && code <= 77) return { icon: "ðŸŒ¨ï¸", label: "Snow" };
      if (code >= 80 && code <= 82) return { icon: "ðŸŒ¦ï¸", label: "Rain showers" };
      if (code >= 85 && code <= 86) return { icon: "ðŸŒ¨ï¸", label: "Snow showers" };
      if (code === 95) return { icon: "â›ˆï¸", label: "Thunderstorm" };
      if (code === 96 || code === 99) return { icon: "â›ˆï¸", label: "Thunderstorm with hail" };
      return { icon: "â“", label: "Unknown weather" };
    }

    async function fetchWeatherForSpot(lat, lng, el) {
      try {
        el.textContent = "Weather: loadingâ€¦";

        const url =
          `https://api.open-meteo.com/v1/forecast` +
          `?latitude=${lat}&longitude=${lng}` +
          `&current_weather=true`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("Open-Meteo error");

        const data = await res.json();
        const cw = data.current_weather || {};

        const temp    = typeof cw.temperature === "number" ? cw.temperature : null;
        const windKmh = typeof cw.windspeed === "number" ? cw.windspeed : null;
        const windMs  = windKmh != null ? windKmh / 3.6 : null;
        const code    = cw.weathercode;

        const { icon, label } = getWeatherIconAndLabel(code);

        const parts = [];
        if (label)          parts.push(label);
        if (temp != null)   parts.push(`${temp.toFixed(1)} Â°C`);
        if (windMs != null) parts.push(`wind ${windMs.toFixed(1)} m/s`);

        const text = parts.join(", ");

        el.textContent = text
          ? `Weather now: ${icon} ${text}`
          : "Weather: not available";
      } catch (err) {
        console.error(err);
        el.textContent = "Weather: failed to load";
      }
    }

    /* ---------------- SPOTS ---------------- */

    function renderSpots() {
      const spotsEl = document.getElementById("spotsContainer");
      spotsEl.innerHTML = "";

      if (!spots.length) {
        spotsEl.innerHTML = `<p class="empty-state">No fishing spots yet.</p>`;
        return;
      }

      spots
        .slice()
        .sort((a, b) => (a.name || "").localeCompare(b.name || ""))
        .forEach(spot => {
          const spotCatches = catches.filter(c => c.spotId === spot.id);

          let statsLine = "No catches yet";
          if (spotCatches.length) {
            let biggest = spotCatches[0];
            spotCatches.forEach(c => {
              if (Number(c.weightKg) > Number(biggest.weightKg)) {
                biggest = c;
              }
            });
            statsLine =
              `Total catches: ${spotCatches.length} â€¢ ` +
              `Biggest: ${Number(biggest.weightKg).toFixed(2)} kg ${biggest.species}`;
          }

          const hasCoords =
            typeof spot.latitude === "number" &&
            typeof spot.longitude === "number";

          const mapsLink = hasCoords
            ? `https://www.google.com/maps?q=${spot.latitude},${spot.longitude}`
            : "";

          const block = document.createElement("div");
          block.className = "spot-block";

          block.innerHTML = `
            <div class="spot-header">
              <div class="spot-name-buttons">
                <a class="tiny-secondary-btn"
                   href="spot.html?id=${encodeURIComponent(spot.id)}">
                   ${spot.name}
                </a>
                <a class="tiny-secondary-btn"
                   href="add-catch.html?spotId=${encodeURIComponent(spot.id)}">
                   Add catch
                </a>
              </div>
            </div>

            <div class="spot-stats">${statsLine}</div>
            <div class="spot-weather"></div>

            <div class="spot-actions-row" style="margin-top:4px;">
              <a class="tiny-secondary-btn"
                 href="predictions.html?spotId=${encodeURIComponent(spot.id)}">
                 Predictions (next 3 days)
              </a>
              ${
                hasCoords
                  ? `<a class="tiny-secondary-btn"
                       href="${mapsLink}" target="_blank">
                       Google Maps
                     </a>`
                  : ""
              }
            </div>
          `;

          const weatherEl = block.querySelector(".spot-weather");
          if (hasCoords) {
            fetchWeatherForSpot(spot.latitude, spot.longitude, weatherEl);
          } else {
            weatherEl.textContent = "Weather: no GPS for this spot";
          }

          spotsEl.appendChild(block);
        });
    }
  </script>
</body>
</html>
