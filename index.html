<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Fishing Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Load external CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <header>
      <h1>My Fishing Log</h1>
      <p>Track your catches anywhere – now with login.</p>
    </header>

    <!-- AUTH CARD (shown when logged out) -->
    <div class="card" id="authCard">
      <h2 class="section-title">Log in or sign up</h2>

      <label for="authEmail">Email</label>
      <input id="authEmail" type="email" placeholder="you@example.com" />

      <label for="authPassword">Password</label>
      <input id="authPassword" type="password" placeholder="Choose a password" />

      <div class="auth-buttons">
        <button id="loginBtn">Log in</button>
        <button id="signupBtn" class="secondary-btn">Sign up</button>
      </div>

      <p id="authMessage" class="auth-message"></p>
    </div>

    <!-- USER CARD (shown when logged in) -->
    <div class="card" id="userCard" style="display:none;">
      <div class="user-row">
        <div>
          <div class="user-label">Logged in as</div>
          <div class="user-email" id="userEmail"></div>
        </div>
        <button id="logoutBtn" class="secondary-btn">Log out</button>
      </div>
    </div>

    <!-- MAIN APP CONTENT (hidden until user logged in) -->
    <div id="appContent" style="display:none;">
      <!-- Stats Card -->
      <div class="card">
        <h2 class="section-title">Stats</h2>
        <div id="stats" class="stats-container">
          <p class="empty-state">No stats yet – add your first catch!</p>
        </div>
      </div>

      <!-- Add Catch Form -->
      <div class="card">
        <h2 class="section-title">Add a catch</h2>

        <label for="species">Species</label>
        <input id="species" type="text" placeholder="Pike, Perch, Carp..." />

        <label for="weight">Weight (kg)</label>
        <input id="weight" type="number" step="0.01" placeholder="e.g. 2.4" />

        <label for="spot">Spot name</label>
        <input id="spot" type="text" placeholder="Lake X, River Y..." />

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="Weather, lure, depth, etc."></textarea>

        <label for="photo">Photo (optional)</label>
        <input id="photo" type="file" accept="image/*" />

        <button id="addCatchBtn">Save catch</button>
      </div>

      <!-- List of catches -->
      <div class="card">
        <h2 class="section-title">Your catches</h2>
        <div id="catchList" class="catch-list">
          <p class="empty-state">No catches yet. Add your first one!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- All JS in one module script so we can use Firebase imports -->
  <script type="module">
    // ---- IMPORT FIREBASE (from CDN) ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ---- YOUR FIREBASE CONFIG (from your screenshot) ----
    const firebaseConfig = {
      apiKey: "AIzaSyCXID74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1658087867882",
      appId: "1:1658087867882:web:e59ddd8f6353d190080e93"
      // measurementId is optional; not needed here
    };

    // ---- INITIALIZE FIREBASE ----
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ---- APP STATE ----
    let currentUser = null;
    let catches = [];

    function storageKeyForUser(uid) {
      return `fishing_catches_${uid}`;
    }

    // Load from localStorage for current user
    function loadCatches() {
      if (!currentUser) return [];
      const key = storageKeyForUser(currentUser.uid);
      const json = localStorage.getItem(key);
      if (!json) return [];
      try {
        return JSON.parse(json);
      } catch (e) {
        console.error("Error parsing stored catches", e);
        return [];
      }
    }

    // Save to localStorage for current user
    function saveCatches(catchesArray) {
      if (!currentUser) return;
      const key = storageKeyForUser(currentUser.uid);
      localStorage.setItem(key, JSON.stringify(catchesArray));
    }

    // ---- STATS RENDERING ----
    function renderStats() {
      const statsEl = document.getElementById("stats");
      if (!statsEl) return;

      statsEl.innerHTML = "";

      if (!currentUser || catches.length === 0) {
        const p = document.createElement("p");
        p.className = "empty-state";
        p.textContent = currentUser
          ? "No stats yet – add your first catch!"
          : "Log in to see stats for your catches.";
        statsEl.appendChild(p);
        return;
      }

      const total = catches.length;
      let biggest = catches[0];
      let totalWeight = 0;
      const speciesCounts = {};

      catches.forEach(c => {
        const w = typeof c.weightKg === "number" ? c.weightKg : 0;
        totalWeight += w;
        if (w > (biggest.weightKg || 0)) {
          biggest = c;
        }
        if (c.species) {
          speciesCounts[c.species] = (speciesCounts[c.species] || 0) + 1;
        }
      });

      const avgWeight = totalWeight / total;
      let topSpecies = null;
      let topCount = 0;
      for (const [species, count] of Object.entries(speciesCounts)) {
        if (count > topCount) {
          topCount = count;
          topSpecies = species;
        }
      }

      const list = document.createElement("div");
      list.className = "stats";

      function addStat(label, value) {
        const item = document.createElement("div");
        item.className = "stat-pill";
        item.innerHTML = `
          <span class="stat-label">${label}</span>
          <span class="stat-value">${value}</span>
        `;
        list.appendChild(item);
      }

      addStat("Total", `${total} catch${total === 1 ? "" : "es"}`);
      addStat("Biggest", `${biggest.weightKg.toFixed(2)} kg ${biggest.species}`);
      addStat("Avg weight", `${avgWeight.toFixed(2)} kg`);
      if (topSpecies) {
        addStat("Most common", `${topSpecies} (${topCount})`);
      }

      statsEl.appendChild(list);
    }

    // ---- CATCHES RENDERING ----
    function renderCatches() {
      const listEl = document.getElementById("catchList");
      listEl.innerHTML = "";

      if (!currentUser) {
        const p = document.createElement("p");
        p.className = "empty-state";
        p.textContent = "Log in to see your catches.";
        listEl.appendChild(p);
        renderStats();
        return;
      }

      if (catches.length === 0) {
        const p = document.createElement("p");
          p.className = "empty-state";
        p.textContent = "No catches yet. Add your first one!";
        listEl.appendChild(p);
        renderStats();
        return;
      }

      catches
        .slice()
        .reverse()
        .forEach(c => {
          const wrapper = document.createElement("div");
          wrapper.className = "catch-item";

          const top = document.createElement("div");
          top.className = "catch-top";
          top.innerHTML = `
            <span>${c.species} • ${c.weightKg.toFixed(2)} kg</span>
            <span>${new Date(c.timestamp).toLocaleDateString()}</span>
          `;

          const meta = document.createElement("div");
          meta.className = "catch-meta";
          meta.textContent = c.spotName || "Unknown spot";

          const note = document.createElement("div");
          note.className = "catch-meta";
          note.textContent = c.notes || "";

          wrapper.appendChild(top);
          wrapper.appendChild(meta);
          if (c.notes) wrapper.appendChild(note);

          if (c.photoDataUrl) {
            const img = document.createElement("img");
            img.className = "catch-photo";
            img.src = c.photoDataUrl;
            img.alt = `${c.species} photo`;
            wrapper.appendChild(img);
          }

          const actions = document.createElement("div");
          actions.className = "catch-actions";

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "delete-btn";
          deleteBtn.textContent = "Delete";
          deleteBtn.addEventListener("click", () => deleteCatch(c.id));

          actions.appendChild(deleteBtn);
          wrapper.appendChild(actions);

          const separator = document.createElement("div");
          separator.style.height = "12px";

          listEl.appendChild(wrapper);
          listEl.appendChild(separator);
        });

      renderStats();
    }

    // ---- DELETE CATCH ----
    function deleteCatch(id) {
      const confirmed = confirm("Delete this catch? This cannot be undone.");
      if (!confirmed) return;

      catches = catches.filter(c => c.id !== id);
      saveCatches(catches);
      renderCatches();
    }

    // ---- FORM: ADD CATCH ----
    const speciesInput = document.getElementById("species");
    const weightInput = document.getElementById("weight");
    const spotInput = document.getElementById("spot");
    const notesInput = document.getElementById("notes");
    const photoInput = document.getElementById("photo");
    const addCatchBtn = document.getElementById("addCatchBtn");

    if (addCatchBtn) {
      addCatchBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("Please log in first.");
          return;
        }

        const species = speciesInput.value.trim();
        const weightValue = parseFloat(weightInput.value);
        const spotValue = spotInput.value.trim();
        const notesValue = notesInput.value.trim();
        const file = photoInput.files[0];

        if (!species || isNaN(weightValue)) {
          alert("Please enter at least species and weight.");
          return;
        }

        const createCatch = (photoDataUrl) => {
          const newCatch = {
            id: Date.now(),
            species,
            weightKg: weightValue,
            spotName: spotValue,
            notes: notesValue,
            timestamp: Date.now(),
            photoDataUrl
          };

          catches.push(newCatch);
          saveCatches(catches);
          renderCatches();

          speciesInput.value = "";
          weightInput.value = "";
          spotInput.value = "";
          notesInput.value = "";
          photoInput.value = "";
        };

        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => createCatch(event.target.result);
          reader.readAsDataURL(file);
        } else {
          createCatch(null);
        }
      });
    }

    // ---- AUTH UI ELEMENTS ----
    const authCard = document.getElementById("authCard");
    const userCard = document.getElementById("userCard");
    const appContent = document.getElementById("appContent");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const authMessage = document.getElementById("authMessage");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userEmailEl = document.getElementById("userEmail");

    function setAuthMessage(text) {
      authMessage.textContent = text || "";
    }

    function setLoggedInUI(user) {
      authCard.style.display = "none";
      userCard.style.display = "block";
      appContent.style.display = "block";
      userEmailEl.textContent = user.email || user.uid;
    }

    function setLoggedOutUI() {
      authCard.style.display = "block";
      userCard.style.display = "none";
      appContent.style.display = "none";
      userEmailEl.textContent = "";
      catches = [];
      renderCatches(); // will show "log in" / empty state
    }

    // ---- AUTH EVENT HANDLERS ----
    if (loginBtn) {
      loginBtn.addEventListener("click", async () => {
        const email = authEmail.value.trim();
        const password = authPassword.value.trim();
        if (!email || !password) {
          setAuthMessage("Please enter email and password.");
          return;
        }
        setAuthMessage("Logging in...");
        try {
          await signInWithEmailAndPassword(auth, email, password);
          setAuthMessage("");
        } catch (err) {
          console.error(err);
          setAuthMessage(err.message);
        }
      });
    }

    if (signupBtn) {
      signupBtn.addEventListener("click", async () => {
        const email = authEmail.value.trim();
        const password = authPassword.value.trim();
        if (!email || !password) {
          setAuthMessage("Please enter email and password.");
          return;
        }
        setAuthMessage("Creating account...");
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          setAuthMessage("Account created! You are now logged in.");
        } catch (err) {
          console.error(err);
          setAuthMessage(err.message);
        }
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
        } catch (err) {
          console.error(err);
          alert("Error logging out");
        }
      });
    }

    // ---- AUTH STATE LISTENER ----
    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;
      if (currentUser) {
        setLoggedInUI(currentUser);
        catches = loadCatches();
        renderCatches();
      } else {
        setLoggedOutUI();
      }
    });

    // Initial render (not logged in)
    renderCatches();
  </script>
</body>
</html>
