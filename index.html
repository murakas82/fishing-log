<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Fishing Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app fade-in">
    <header class="card">
      <div class="card-header">
        <div>
          <h1>My Fishing Log</h1>
          <p class="muted-text">
            Track your catches anywhere – with login, spots, weather & predictions.
          </p>
        </div>
        <div id="authArea">
          <!-- Filled by JS -->
        </div>
      </div>
    </header>

    <!-- Stats -->
    <div class="card" id="statsCard" style="display:none;">
      <h2>Stats</h2>
      <div id="statsContent" class="stat-badges"></div>
    </div>

    <!-- My fishing spots -->
    <div class="card" id="spotsCard" style="display:none;">
      <div class="card-header">
        <h2>My fishing spots</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="secondary-btn" id="mapViewBtn">Map view</button>
          <button class="secondary-btn" id="addSpotBtn">Add new spot</button>
        </div>
      </div>
      <div id="spotsList"></div>
    </div>

    <!-- Loading state before auth resolved -->
    <div class="card" id="loadingCard">
      <div class="loading-center">
        <div class="spinner"></div>
        <div>Loading app…</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp }
      from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXIdT74cNDSVIoMs3NZ86tPf2kzFm8Iug",
      authDomain: "fishing-log-app-murx.firebaseapp.com",
      projectId: "fishing-log-app-murx",
      storageBucket: "fishing-log-app-murx.firebasestorage.app",
      messagingSenderId: "1056807867882",
      appId: "1:1056807867882:web:e59ddd8f6353d190080e93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const authArea     = document.getElementById("authArea");
    const loadingCard  = document.getElementById("loadingCard");
    const statsCard    = document.getElementById("statsCard");
    const statsContent = document.getElementById("statsContent");
    const spotsCard    = document.getElementById("spotsCard");
    const spotsList    = document.getElementById("spotsList");
    const mapViewBtn   = document.getElementById("mapViewBtn");
    const addSpotBtn   = document.getElementById("addSpotBtn");

    function renderAuthForm(errorMessage = "") {
      authArea.innerHTML = `
        <div>
          <form id="authForm" style="display:flex;flex-direction:column;gap:6px;min-width:260px;">
            <div style="font-size:0.85rem;">Log in or sign up</div>
            <input type="email" id="authEmail" placeholder="Email" required />
            <input type="password" id="authPassword" placeholder="Password" required />
            <div style="display:flex;gap:8px;">
              <button type="submit" class="primary-btn" data-mode="login">Log in</button>
              <button type="button" class="secondary-btn" id="signUpBtn">Sign up</button>
            </div>
            <div id="authError" class="muted-text" style="color:#f97373;">${errorMessage}</div>
          </form>
        </div>
      `;

      const form = document.getElementById("authForm");
      const signUpBtn = document.getElementById("signUpBtn");

      form.onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById("authEmail").value.trim();
        const pass  = document.getElementById("authPassword").value.trim();
        try {
          await signInWithEmailAndPassword(auth, email, pass);
        } catch (err) {
          renderAuthForm("Login failed: " + (err.code || err.message));
        }
      };

      signUpBtn.onclick = async () => {
        const email = document.getElementById("authEmail").value.trim();
        const pass  = document.getElementById("authPassword").value.trim();
        if (!email || !pass) {
          renderAuthForm("Enter email & password, then press Sign up.");
          return;
        }
        try {
          await createUserWithEmailAndPassword(auth, email, pass);
        } catch (err) {
          renderAuthForm("Sign up failed: " + (err.code || err.message));
        }
      };
    }

    function renderLoggedInHeader(user, displayName) {
      const nameText = displayName || user.email || "Unknown user";

      authArea.innerHTML = `
        <div style="text-align:right;display:flex;flex-direction:column;gap:4px;">
          <div style="font-size:0.86rem;">
            Logged in as <strong>${nameText}</strong>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;">
            <button class="secondary-btn" id="settingsBtn">Settings</button>
            <button class="secondary-btn btn-back-main" id="logoutBtn">← Log out</button>
          </div>
        </div>
      `;

      const logoutBtn = document.getElementById("logoutBtn");
      const settingsBtn = document.getElementById("settingsBtn");

      logoutBtn.onclick = () => signOut(auth);
      settingsBtn.onclick = () => {
        window.location.href = "settings.html";
      };
    }

    async function loadUserDisplayName(userId) {
      const profileRef = doc(db, "profiles", userId);
      const snap = await getDoc(profileRef);
      if (!snap.exists()) return null;
      return snap.data().displayName || null;
    }

    async function loadStats(user) {
      const q = query(
        collection(db, "catches"),
        where("userId", "==", user.uid)
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        statsContent.innerHTML = `<div class="muted-text">No catches yet.</div>`;
        return;
      }

      let total = 0;
      let totalWeight = 0;
      let biggestWeight = 0;
      let biggestSpecies = "-";

      snap.forEach(docSnap => {
        const c = docSnap.data();
        total += 1;
        if (typeof c.weightKg === "number" && !isNaN(c.weightKg)) {
          totalWeight += c.weightKg;
          if (c.weightKg > biggestWeight) {
            biggestWeight = c.weightKg;
            biggestSpecies = c.species || "-";
          }
        }
      });

      const avgWeight = totalWeight && total ? (totalWeight / total) : 0;

      statsContent.innerHTML = `
        <span class="stat-pill">Total catches <strong>${total}</strong></span>
        <span class="stat-pill">Biggest fish <strong>${biggestWeight.toFixed(2)} kg ${biggestSpecies}</strong></span>
        <span class="stat-pill">Average weight <strong>${avgWeight.toFixed(2)} kg</strong></span>
      `;
    }

    async function loadSpots(user) {
      const q = query(
        collection(db, "spots"),
        where("userId", "==", user.uid)
      );
      const snap = await getDocs(q);

      if (snap.empty) {
        spotsList.innerHTML = `<p class="muted-text">No spots yet. Add your first fishing spot.</p>`;
        return;
      }

      const spots = [];
      snap.forEach(docSnap => spots.push({ id: docSnap.id, ...docSnap.data() }));

      // For each spot, load catches for stats (simple, not heavily optimised)
      const catchesSnap = await getDocs(
        query(collection(db, "catches"), where("userId", "==", user.uid))
      );
      const allCatches = catchesSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      spotsList.innerHTML = "";
      for (const spot of spots) {
        const spotDiv = document.createElement("div");
        spotDiv.className = "spot-row";

        const spotCatches = allCatches.filter(c => c.spotId === spot.id);
        const total = spotCatches.length;
        let biggestWeight = 0;
        let biggestSpecies = "-";

        spotCatches.forEach(c => {
          if (typeof c.weightKg === "number" && !isNaN(c.weightKg)) {
            if (c.weightKg > biggestWeight) {
              biggestWeight = c.weightKg;
              biggestSpecies = c.species || "-";
            }
          }
        });

        const statsLine = total
          ? `Total catches: ${total} • Biggest: ${biggestWeight.toFixed(2)} kg ${biggestSpecies}`
          : "No catches yet.";

        const mapsUrl =
          typeof spot.latitude === "number" && typeof spot.longitude === "number"
            ? `https://www.google.com/maps?q=${spot.latitude},${spot.longitude}`
            : null;

        spotDiv.innerHTML = `
          <div class="spot-header-line">
            <h3>${spot.name || "Unnamed spot"}</h3>
            <span class="muted-text">${total} catches</span>
          </div>
          <div class="muted-text">${statsLine}</div>
        `;

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "spot-actions";

        const openBtn = document.createElement("button");
        openBtn.className = "secondary-btn";
        openBtn.textContent = "Open spot";
        openBtn.onclick = () => {
          window.location.href = `spot.html?id=${encodeURIComponent(spot.id)}`;
        };

        const addCatchBtn = document.createElement("button");
        addCatchBtn.className = "secondary-btn";
        addCatchBtn.textContent = "Add catch";
        addCatchBtn.onclick = () => {
          window.location.href = `add-catch.html?spotId=${encodeURIComponent(
            spot.id
          )}`;
        };

        const predBtn = document.createElement("button");
        predBtn.className = "secondary-btn";
        predBtn.textContent = "Predictions";
        predBtn.onclick = () => {
          window.location.href = `predictions.html?spotId=${encodeURIComponent(
            spot.id
          )}`;
        };

        actionsDiv.appendChild(openBtn);
        actionsDiv.appendChild(addCatchBtn);
        actionsDiv.appendChild(predBtn);

        if (mapsUrl) {
          const mapsBtn = document.createElement("a");
          mapsBtn.className = "secondary-btn";
          mapsBtn.href = mapsUrl;
          mapsBtn.target = "_blank";
          mapsBtn.rel = "noopener noreferrer";
          mapsBtn.textContent = "Google Maps";
          actionsDiv.appendChild(mapsBtn);
        }

        spotDiv.appendChild(actionsDiv);
        spotsList.appendChild(spotDiv);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      loadingCard.style.display = "none";

      if (!user) {
        statsCard.style.display = "none";
        spotsCard.style.display = "none";
        renderAuthForm();
        return;
      }

      const displayName = await loadUserDisplayName(user.uid);
      renderLoggedInHeader(user, displayName);

      statsCard.style.display = "block";
      spotsCard.style.display = "block";

      await loadStats(user);
      await loadSpots(user);
    });

    mapViewBtn.onclick = () => {
      window.location.href = "spots-map.html";
    };

    addSpotBtn.onclick = () => {
      window.location.href = "add-spot.html";
    };
  </script>
</body>
</html>

